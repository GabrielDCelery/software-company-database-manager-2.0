var DatabaseApp=angular.module("DatabaseApp",["ngRoute","ngCookies","checklist-model","AuthCtrl","AuthFactory","CompaniesCtrl","DatabaseFactory","MailingCtrl","MailingFactory","SubMenuFactory","FilteredSearchFactory","FormatDataFactory","AlertsFactory","DocMakerFactory"]);DatabaseApp.config(["$routeProvider","$locationProvider",function(e,a){e.when("/companies",{templateUrl:"templates/companies/_companies_main.html",controller:"CompaniesCtrl"}).when("/mailing",{templateUrl:"templates/mailing/_mailing_main.html",controller:"MailingCtrl"}).otherwise({redirectTo:"/"})}]);var AuthCtrl=angular.module("AuthCtrl",[]);AuthCtrl.controller("AuthCtrl",["$scope","AuthFactory",function(e,a){function t(t,n){a.login(t,n,function(i){i.data?(e.loggedIn=!0,a.setLoginCookie(t,n)):e.loggedIn=!1})}function n(){e.loggedIn=!1,a.clearLoginCookie()}function i(e){a.getLoginCookie(e)}e.loggedIn=!1,e.login=t,e.logout=n,i(t)}]);var AuthFactory=angular.module("AuthFactory",[]);AuthFactory.factory("AuthFactory",["$http","$cookies",function(e,a){function t(a,t,n){t=s.encode(t),e.post("php/login.php",{username:a,password:t}).success(n)}function n(e,t){var n=s.encode(e),i=s.encode(r.encode(t)),o={username:n,password:i};a.putObject("userCookie",o)}function i(){a.remove("userCookie")}function o(e){var t=a.getObject("userCookie");if(t){var n=s.decode(t.username),i=r.decode(s.decode(t.password));e(n,i)}}var r={secretOne:"kuhp",secretTwo:"w894",encode:function(e){return this.secretOne+e+this.secretTwo},decode:function(e){return e=e.slice(this.secretOne.length),e.slice(0,e.length-this.secretTwo.length)}},s={keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var a,t,n,i,o,r="",s="",c="",l=0;do a=e.charCodeAt(l++),t=e.charCodeAt(l++),s=e.charCodeAt(l++),n=a>>2,i=(3&a)<<4|t>>4,o=(15&t)<<2|s>>6,c=63&s,isNaN(t)?o=c=64:isNaN(s)&&(c=64),r=r+this.keyStr.charAt(n)+this.keyStr.charAt(i)+this.keyStr.charAt(o)+this.keyStr.charAt(c),a=t=s="",n=i=o=c="";while(l<e.length);return r},decode:function(e){var a,t,n,i,o,r="",s="",c="",l=0,d=/[^A-Za-z0-9\+\/\=]/g;d.exec(e)&&window.alert("There were invalid base64 characters in the input text.\nValid base64 characters are A-Z, a-z, 0-9, '+', '/',and '='\nExpect errors in decoding."),e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");do n=this.keyStr.indexOf(e.charAt(l++)),i=this.keyStr.indexOf(e.charAt(l++)),o=this.keyStr.indexOf(e.charAt(l++)),c=this.keyStr.indexOf(e.charAt(l++)),a=n<<2|i>>4,t=(15&i)<<4|o>>2,s=(3&o)<<6|c,r+=String.fromCharCode(a),64!=o&&(r+=String.fromCharCode(t)),64!=c&&(r+=String.fromCharCode(s)),a=t=s="",n=i=o=c="";while(l<e.length);return r}};return{login:t,setLoginCookie:n,clearLoginCookie:i,getLoginCookie:o}}]);var CompaniesCtrl=angular.module("CompaniesCtrl",[]);CompaniesCtrl.controller("CompaniesCtrl",["$scope","$http","$window","SubMenu","FilteredSearch","FormatData","Alerts","Database","DocMaker",function(e,a,t,n,i,o,r,s,c){function l(){e.filteredListOfCompanies=[],e.filteredListOfManagers=[],e.selectedCompanies.id=[],e.selectedCompanies.allChecked=!1,e.display.form.searchCompany=!1,e.display.form.sendEmail=!1,e.display.form.showDetails=!1,e.display.form.extendContract=!1,e.display.form.addNewCompany=!1,e.display.data.list=!0,e.display.data.edit=!1,e.display.data.extend=!1}function d(){e.display.form.searchCompany=!1,e.display.form.sendEmail=!1,e.display.form.showDetails=!1,e.display.form.extendContract=!1,e.display.form.addNewCompany=!1,e.display.data.list=!1,e.display.data.edit=!0,e.display.data.extend=!1}function m(){e.display.form.searchCompany=!1,e.display.form.sendEmail=!1,e.display.form.showDetails=!1,e.display.form.extendContract=!1,e.display.form.addNewCompany=!1,e.display.data.list=!1,e.display.data.edit=!1,e.display.data.extend=!0}function p(a){r.isAnythingSelected(e.selectedCompanies.id,function(e){s.getDetailedCompaniesData(e,function(e){var t=new o.DataObject(e);t.addColourCoding().formatPostalServiceToString().formatDateCorrectly(),a(t.data)})})}function f(e,a){var t=[];t.push(e);var n=new o.DataObject(t);n.formatPostalServiceToBoolean(),a(n.data)}function u(a){i.filterCompanyNames(a,function(a){e.filteredListOfCompanies=a})}function h(a){e.form.searchCompany.companyName=a,e.filteredListOfCompanies=[]}function y(a){i.filterManagerNames(a,function(a){e.filteredListOfManagers=a})}function g(a){e.form.searchCompany.managerName=a,e.filteredListOfManagers=[]}function C(a){s.getShortCompaniesData(a,function(a){var t=new o.DataObject(a);t.addColourCoding(),e.companyDataList=t.data,l()})}function _(){r.isAnythingSelected(e.selectedCompanies.id,function(a){switch(e.selectedCompanies.id=a,e.emailToCompanies.subject){case"A szerződés lejárt":e.selectedCompanies.type="contractexpired",e.selectedCompanies.subject="A szerződés lejárt";break;case"Utolsó figyelmeztetés":e.selectedCompanies.type="lastwarning",e.selectedCompanies.subject="Utolsó figyelmeztetés"}s.mailToSelectedCompanies(e.selectedCompanies,function(e){r.checkSuccess(e)})})}function M(){p(function(a){e.companyDataEdit=a,e.companyDataEditMaster=angular.copy(e.companyDataEdit),d()})}function w(e){f(e,function(e){s.overWriteCompanyData(e,function(e){r.checkSuccess(e),M()})})}function D(){e.companyDataEdit=angular.copy(e.companyDataEditMaster)}function v(){r.isAnythingSelected(e.selectedCompanies.id,function(a){r.confirmChange(a,function(a){s.changeContractStatus(a,function(a){r.checkSuccess(a),e.form.searchCompany.validContract&&e.form.searchCompany.expiredContract||(e.form.searchCompany.validContract=!e.form.searchCompany.validContract,e.form.searchCompany.expiredContract=!e.form.searchCompany.expiredContract),C(e.form.searchCompany)})})})}function F(){p(function(a){e.companyDataExtend=a,e.companyDataExtendMaster=angular.copy(e.companyDataExtend),m()})}function A(a){f(a,function(a){s.extendContract(a,function(a){r.checkSuccess(a),C(e.form.searchCompany)})})}function N(){e.companyDataExtend=angular.copy(e.companyDataExtendMaster)}function S(e){f(e,function(e){s.addNewCompany(e,function(e){r.checkSuccess(e)})})}function k(e){c.createCover(e,function(){window.location.replace("cover.docx")})}function L(e){f(e,function(e){c.createContract(e[0],function(){window.location.replace("contract.docx")})})}function b(){0==e.selectedCompanies.allChecked?(angular.forEach(e.companyDataList,function(a){e.selectedCompanies.id.push(a.id)}),e.selectedCompanies.allChecked=!0):(e.selectedCompanies.id=[],e.selectedCompanies.allChecked=!1)}function x(a){n.displayContent(e.display.form,a,function(a){e.display.form=a})}function O(){e.display=angular.copy(e.displayMaster),e.selectedCompanies=angular.copy(e.displayMaster),e.companyDataList=angular.copy(e.companyDataListMaster),e.companyDataEdit=angular.copy(e.companyDataEditMaster),e.companyDataExtend=angular.copy(e.companyDataExtendMaster)}e.display={form:{searchCompany:!1,sendEmail:!1,showDetails:!1,extendContract:!1,addNewCompany:!1},data:{list:!1,edit:!1,extend:!1}},e.form={searchCompany:{companyName:"",managerName:"",validContract:!0,expiredContract:!1,startingDate:null,endingDate:null,lastContractOnly:!0},addNewCompany:{company_name:"",starting_date:new Date,ending_date:new Date,company_phone:"",company_email:"",invoice_number:"",service_provider:"Zeller és Zeller Kft.",transfer_date:new Date,invoice_date:new Date,payment_method:"",account_number:"",price_of_serv_num:0,price_of_serv_let:"",company_address:"",company_register_id:"",company_tax_id:"",postal_number:"",postal_service:"nem",postal_name:"",postal_address:"",manager_name:"",manager_status:"ügyvezető",manager_id:"",manager_mother_name:"",manager_address:"",document_holder:"",document_holder_address:""}},e.filteredListOfCompanies=[],e.filteredListOfManagers=[],e.companyDataList=[],e.sortField="company_name",e.reverseSortField=!1,e.companyDataEdit=[],e.companyDataExtend=[],e.selectedCompanies={id:[],allChecked:!1},e.emailToCompanies={subject:"A szerződés lejárt"},e.displayMaster=angular.copy(e.display),e.selectedCompaniesMaster=angular.copy(e.selectedCompanies),e.companyDataEditMaster=[],e.companyDataExtendMaster=[],e.companyDataListMaster=[],e.menu=x,e.reset=O,e.filterListOfCompanyNames=u,e.filterListOfManagerNames=y,e.insertCompanyNameToInputField=h,e.insertManagerNameToInputField=g,e.formGetCompanyDataList=C,e.formGetCompanyDataEdit=M,e.overwriteCompanyData=w,e.formChangeContractStatus=v,e.formGetCompanyDataExtend=F,e.addExtendedContract=A,e.addNewCompany=S,e.displayCompanyDataList=l,e.resetFormCompanyDataEdit=D,e.resetFormCompanyDataExtend=N,e.docCreateCover=k,e.docCreateContract=L,e.mailToSelectedCompanies=_,e.checkAllCompanies=b}]);var DatabaseFactory=angular.module("DatabaseFactory",[]);DatabaseFactory.factory("Database",["$http",function(e){function a(a,t){e.post("php/companies/form_search_companies.php",a).success(function(e){t(e)})}function t(a,t){e.post("php/companies/form_companies_detailed.php",a).success(function(e){t(e)})}function n(a,t){e.post("php/companies/form_companies_overwrite_company_data.php",a).success(function(e){t(e)})}function i(a,t){e.post("php/companies/form_companies_change_contract_status.php",a).success(function(e){t(e)})}function o(a,t){e.post("php/companies/form_companies_extend_contract.php",a).success(function(e){t(e)})}function r(a,t){e.post("php/companies/form_companies_add_new_company.php",a).success(function(e){t(e)})}function s(a,t){e.post("php/companies/form_companies_mail_to_companies.php",a).success(function(e){t(e)})}function c(a,t){e.post("php/mailing/form_search_mails.php",a).success(function(e){t(e)})}function l(a,t){e.post("php/mailing/form_overwrite_mails.php",a).success(function(e){t(e)})}function d(a,t){e.post("php/mailing/form_delete_mails.php",a).success(function(e){t(e)})}function m(a,t){e.post("php/mailing/form_forward_mails.php",a).success(function(e){t(e)})}function p(a,t){e.post("php/mailing/form_add_new_mails.php",a).success(function(e){t(e)})}return{getShortCompaniesData:a,getDetailedCompaniesData:t,overWriteCompanyData:n,changeContractStatus:i,extendContract:o,addNewCompany:r,mailToSelectedCompanies:s,getMailData:c,overwriteMailData:l,deleteMailData:d,forwardMailData:m,addNewMails:p}}]);var MailingCtrl=angular.module("MailingCtrl",[]);MailingCtrl.controller("MailingCtrl",["$scope","$window","SubMenu","FilteredSearch","Database","FormatData","Alerts","DocMaker",function(e,a,t,n,i,o,r,s){function c(){e.display.data.list=!0,e.display.form.searchMails=!1,e.display.form.forwardMails=!1,e.display.form.editMails=!1,e.selectedMails.id=[],e.selectedMails.allChecked=!1}function l(a){n.filterCompanyNames(a,function(a){e.filteredListOfCompanies=a})}function d(a){e.form.searchMail.companyName=a,e.form.addNewMail.companyName=a,e.filteredListOfCompanies=[]}function m(a){i.getMailData(a,function(a){var t=new o.DataObject(a);t.formatDateCorrectlyForMail().addColourCodingToMail(),e.mailDataList=t.data,c()})}function p(){r.isAnythingSelected(e.selectedMails.id,function(a){e.form.forwardMail.id=a,i.forwardMailData(e.form.forwardMail,function(a){r.checkSuccess(a),e.form.searchMail.forwarded=!0,m(e.form.searchMail)})})}function f(){r.isAnythingSelected(e.selectedMails.id,function(a){var t=s.createDataObjectForReceit(a,e.mailDataList);s.createReceit(t,function(e){window.location.replace("receit.docx")})})}function u(){r.isAnythingSelected(e.selectedMails.id,function(a){for(var t=0;t<e.mailDataList.length;t++)e.mailDataList[t].show_input=!1;for(var t=0;t<e.selectedMails.id.length;t++)for(var n=0;n<e.mailDataList.length;n++)e.selectedMails.id[t]==e.mailDataList[n].mail_id&&(e.mailDataList[n].show_input=!0)})}function h(){e.mailDataList=angular.copy(e.mailDataListMaster)}function y(){r.isAnythingSelected(e.selectedMails.id,function(a){i.overwriteMailData(e.mailDataList,function(a){r.checkSuccess(a),m(e.form.searchMail)})})}function g(){r.isAnythingSelected(e.selectedMails.id,function(a){i.deleteMailData(a,function(a){r.checkSuccess(a),m(e.form.searchMail)})})}function C(){e.form.addNewMail.mails.push({senderName:"",senderAddress:""})}function _(a){var t=e.form.addNewMail.mails.indexOf(a);-1!=t&&e.form.addNewMail.mails.length>1&&e.form.addNewMail.mails.splice(t,1)}function M(a){n.filterMailingAddresses(a.senderName,a.senderAddress,function(t){e.filteredListOfMailingAddresses=t;for(var n=e.form.addNewMail.mails.indexOf(a),i=0;i<e.form.addNewMail.mails.length;i++)e.form.addNewMail.mails[i].activeField=!1;e.form.addNewMail.mails[n].activeField=!0})}function w(a){for(var t=0;t<e.form.addNewMail.mails.length;t++)1==e.form.addNewMail.mails[t].activeField&&(e.form.addNewMail.mails[t].senderName=a.sender_name,e.form.addNewMail.mails[t].senderAddress=a.sender_address);e.filteredListOfMailingAddresses=[]}function D(){r.fillAddNewMailsForm(e.form.addNewMail.companyName,e.form.addNewMail.receivingDate,e.form.addNewMail.mails,function(){i.addNewMails(e.form.addNewMail,function(a){r.checkSuccess(a),e.form.searchMail={companyName:e.form.addNewMail.companyName,startingDate:null,endingDate:null,nonForwarded:!0,forwarded:!1,hasPostalService:!0,doesntHavePoastalService:!0},m(e.form.searchMail),c()})})}function v(a){t.displayContent(e.display.form,a,function(a){e.display.form=a})}function F(){e.display=angular.copy(e.displayReset),e.mailDataList=[],e.form=angular.copy(e.formMaster),e.display.data.list=!1}function A(){0==e.selectedMails.allChecked?(angular.forEach(e.mailDataList,function(a){e.selectedMails.id.push(a.mail_id)}),e.selectedMails.allChecked=!0):(e.selectedMails.id=[],e.selectedMails.allChecked=!1)}e.display={form:{searchMails:!1,forwardMails:!1,editMails:!1,addNewMails:!1},data:{list:!1}},e.form={searchMail:{companyName:"",startingDate:null,endingDate:null,nonForwarded:!0,forwarded:!1,hasPostalService:!0,doesntHavePoastalService:!0},forwardMail:{forwardingDate:null,forwardingMethod:null,id:null},addNewMail:{companyName:"",receivingDate:null,mails:[{senderName:"",senderAddress:"",activeField:!1}]}},e.mailDataList=[],e.sortField="company_name",e.reverseSortField=!1,e.selectedMails={id:[],allChecked:!1},e.filteredListOfCompanies=[],e.filteredListOfMailingAddresses=[],e.displayReset=angular.copy(e.display),e.mailDataListMaster=angular.copy(e.mailDataList),e.formMaster=angular.copy(e.form),e.menu=v,e.reset=F,e.filterCompanyNames=l,e.insertCompanyNameToInputField=d,e.formGetMailDataList=m,e.checkAll=A,e.checkAllMails=A,e.editMails=u,e.resetMails=h,e.overwriteMails=y,e.deleteMails=g,e.forwardMails=p,e.printReceit=f,e.filterListOfMailingAddresses=M,e.insertMailingAddressToAddNewMailField=w,e.addNewRowToAddMailForm=C,e.removeRowFromAddMailForm=_,e.addNewMails=D}]);var MailingFactory=angular.module("MailingFactory",[]);MailingFactory.factory("MailingFactory",["$http",function(e){}]);var SubMenuFactory=angular.module("SubMenuFactory",[]);SubMenuFactory.factory("SubMenu",[function(){function e(e,a,t){for(var n in e)n==a?e[n]=!0:e[n]=!1;t(e)}return{displayContent:e}}]);var FilteredSearchFactory=angular.module("FilteredSearchFactory",[]);FilteredSearchFactory.factory("FilteredSearch",["$http",function(e){function a(a){c?a(c):e.get("php/companies/fetch_company_names.php").success(function(e){c=e,a(e)})}function t(a){l?a(l):e.get("php/companies/fetch_manager_names.php").success(function(e){l=e,a(e)})}function n(a){d?a(d):e.get("php/mailing/fetch_mailing_addresses.php").success(function(e){d=e,a(e)})}function i(e,a){var t=a,n=[];if(0!==e.length)for(var i=0;i<t.length;i++)t[i].substring(0,e.length).toLowerCase()===e.toLowerCase()&&n.push(t[i]);return n}function o(e,t){a(function(a){t(i(e,a))})}function r(e,a){t(function(t){a(i(e,t))})}function s(e,a,t){var i=[],o=[];n(function(n){if(i=n,0!==e.length||0!==a.length)for(var r=0;r<i.length;r++)i[r].sender_name.substring(0,e.length).toLowerCase()===e.toLowerCase()&&i[r].sender_address.substring(0,a.length).toLowerCase()===a.toLowerCase()&&o.push(i[r]);t(o)})}var c,l,d;return{filterCompanyNames:o,filterManagerNames:r,filterMailingAddresses:s}}]);var FormatDataFactory=angular.module("FormatDataFactory",[]);FormatDataFactory.factory("FormatData",[function(){function e(e){var a=new Date(e);return a}function a(e){this.data=e}return a.prototype.addColourCoding=function(){return this.data.map(function(e){1!=e.contract_status||""!=e.postal_number&&null!=e.postal_number?1==e.contract_status?e.css_color="green":e.css_color="red":e.css_color="yellow"}),this},a.prototype.formatDateCorrectly=function(){return this.data.map(function(a){"1970-01-01"==a.starting_date||"0000-00-00"==a.starting_date||null==a.starting_date?a.starting_date=null:a.starting_date=e(a.starting_date),"1970-01-01"==a.ending_date||"0000-00-00"==a.ending_date||null==a.ending_date?a.ending_date=null:a.ending_date=e(a.ending_date),"1970-01-01"==a.transfer_date||"0000-00-00"==a.transfer_date||null==a.transfer_date?a.transfer_date=null:a.transfer_date=e(a.transfer_date),"1970-01-01"==a.invoice_date||"0000-00-00"==a.invoice_date||null==a.invoice_date?a.invoice_date=null:a.invoice_date=e(a.invoice_date)}),this},a.prototype.formatPostalServiceToString=function(){return this.data.map(function(e){1==e.postal_service?e.postal_service="igen":e.postal_service="nem"}),this},a.prototype.formatPostalServiceToBoolean=function(){return this.data.map(function(e){"igen"==e.postal_service?e.postal_service=1:e.postal_service=0}),this},a.prototype.addColourCodingToMail=function(){return this.data.map(function(e){e.show_input=!1,null==e.forwarding_date?e.css_color="yellow":e.css_color="green"}),this},a.prototype.formatDateCorrectlyForMail=function(){return this.data.map(function(a){a.receiving_date=e(a.receiving_date),"1970-01-01"==a.forwarding_date||"0000-00-00"==a.forwarding_date||null==a.forwarding_date?a.forwarding_date=null:a.forwarding_date=e(a.forwarding_date)}),this},{DataObject:a}}]);var AlertsFactory=angular.module("AlertsFactory",[]);AlertsFactory.factory("Alerts",[function(){function e(e,a){0==e.length?alert("Nem választottál ki semmit!"):a(e)}function a(e){1==e?alert("A feladat sikeresen végrehajtva!"):alert("Nem sikerült a kért műveletet elvégezni!")}function t(e,a){var t=confirm("Végre akarod hajtani a kívánt változtatásokat?");t&&a(e)}function n(e,a,t,n){var i=!1;null!=e&&""!=e||(i=!0),null==a&&(i=!0);for(var o=0;o<t.length;o++)0!=t[o].senderName.length&&0!=t[o].senderAddress.length||(i=!0);1==i?alert("Minden mezőt kötelező kitölteni!"):n()}return{isAnythingSelected:e,checkSuccess:a,confirmChange:t,fillAddNewMailsForm:n}}]);var DocMakerFactory=angular.module("DocMakerFactory",[]);DocMakerFactory.factory("DocMaker",["$http",function(e){function a(a,t){e({method:"POST",url:"php/companies/document_create_cover.php",data:a}).success(function(){t()})}function t(a,t){e({method:"POST",url:"php/companies/document_create_contract.php",data:a}).success(function(){t()})}function n(e,a){for(var t=[],n=0;n<e.length;n++)for(var i=0;i<a.length;i++)e[n]==a[i].mail_id&&t.push(a[i]);return t}function i(a,t){e({method:"POST",url:"php/mailing/document_create_receit.php",data:a}).success(function(){t()})}return{createContract:t,createCover:a,createReceit:i,createDataObjectForReceit:n}}]);
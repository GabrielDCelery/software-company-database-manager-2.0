var DatabaseApp=angular.module("DatabaseApp",["ngRoute","ngCookies","checklist-model","AuthCtrl","AuthFactory","CompaniesCtrl","DatabaseFactory","MailingCtrl","MailingFactory","SubMenuFactory","FilteredSearchFactory","FormatDataFactory","AlertsFactory","DocMakerFactory"]);DatabaseApp.config(["$routeProvider","$locationProvider",function(a,e){a.when("/companies",{templateUrl:"templates/companies/_companies_main.html",controller:"CompaniesCtrl"}).when("/mailing",{templateUrl:"templates/mailing/_mailing_main.html",controller:"MailingCtrl"}).otherwise({redirectTo:"/"})}]);var AuthCtrl=angular.module("AuthCtrl",[]);AuthCtrl.controller("AuthCtrl",["$scope","AuthFactory",function(a,e){function t(t,n){e.login(t,n,function(i){i.data?(a.loggedIn=!0,e.setLoginCookie(t,n)):a.loggedIn=!1})}function n(){a.loggedIn=!1,e.clearLoginCookie()}function i(a){e.getLoginCookie(a)}a.loggedIn=!1,a.login=t,a.logout=n,i(t)}]);var AuthFactory=angular.module("AuthFactory",[]);AuthFactory.factory("AuthFactory",["$http","$cookies",function(a,e){function t(e,t,n){a.post("php/login.php",{username:e,password:t}).success(n)}function n(a,t){var n=r.encode(a),i=r.encode(t),o={username:n,password:i};e.putObject("userCookie",o)}function i(){e.remove("userCookie")}function o(a){var t=e.getObject("userCookie");if(t){var n=r.decode(t.username),i=r.decode(t.password);a(n,i)}}var r={keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(a){var e,t,n,i,o,r="",s="",c="",l=0;do e=a.charCodeAt(l++),t=a.charCodeAt(l++),s=a.charCodeAt(l++),n=e>>2,i=(3&e)<<4|t>>4,o=(15&t)<<2|s>>6,c=63&s,isNaN(t)?o=c=64:isNaN(s)&&(c=64),r=r+this.keyStr.charAt(n)+this.keyStr.charAt(i)+this.keyStr.charAt(o)+this.keyStr.charAt(c),e=t=s="",n=i=o=c="";while(l<a.length);return r},decode:function(a){var e,t,n,i,o,r="",s="",c="",l=0,d=/[^A-Za-z0-9\+\/\=]/g;d.exec(a)&&window.alert("There were invalid base64 characters in the input text.\nValid base64 characters are A-Z, a-z, 0-9, '+', '/',and '='\nExpect errors in decoding."),a=a.replace(/[^A-Za-z0-9\+\/\=]/g,"");do n=this.keyStr.indexOf(a.charAt(l++)),i=this.keyStr.indexOf(a.charAt(l++)),o=this.keyStr.indexOf(a.charAt(l++)),c=this.keyStr.indexOf(a.charAt(l++)),e=n<<2|i>>4,t=(15&i)<<4|o>>2,s=(3&o)<<6|c,r+=String.fromCharCode(e),64!=o&&(r+=String.fromCharCode(t)),64!=c&&(r+=String.fromCharCode(s)),e=t=s="",n=i=o=c="";while(l<a.length);return r}};return{login:t,setLoginCookie:n,clearLoginCookie:i,getLoginCookie:o}}]);var CompaniesCtrl=angular.module("CompaniesCtrl",[]);CompaniesCtrl.controller("CompaniesCtrl",["$scope","$http","$window","SubMenu","FilteredSearch","FormatData","Alerts","Database","DocMaker",function(a,e,t,n,i,o,r,s,c){function l(){a.filteredListOfCompanies=[],a.filteredListOfManagers=[],a.selectedCompanies.id=[],a.selectedCompanies.allChecked=!1,a.display.form.searchCompany=!1,a.display.form.sendEmail=!1,a.display.form.showDetails=!1,a.display.form.extendContract=!1,a.display.form.addNewCompany=!1,a.display.data.list=!0,a.display.data.edit=!1,a.display.data.extend=!1}function d(){a.display.form.searchCompany=!1,a.display.form.sendEmail=!1,a.display.form.showDetails=!1,a.display.form.extendContract=!1,a.display.form.addNewCompany=!1,a.display.data.list=!1,a.display.data.edit=!0,a.display.data.extend=!1}function m(){a.display.form.searchCompany=!1,a.display.form.sendEmail=!1,a.display.form.showDetails=!1,a.display.form.extendContract=!1,a.display.form.addNewCompany=!1,a.display.data.list=!1,a.display.data.edit=!1,a.display.data.extend=!0}function p(e){r.isAnythingSelected(a.selectedCompanies.id,function(a){s.getDetailedCompaniesData(a,function(a){var t=new o.DataObject(a);t.addColourCoding().formatPostalServiceToString().formatDateCorrectly(),e(t.data)})})}function u(a,e){var t=[];t.push(a);var n=new o.DataObject(t);n.formatPostalServiceToBoolean(),e(n.data)}function f(e){i.filterCompanyNames(e,function(e){a.filteredListOfCompanies=e})}function h(e){a.form.searchCompany.companyName=e,a.filteredListOfCompanies=[]}function y(e){i.filterManagerNames(e,function(e){a.filteredListOfManagers=e})}function g(e){a.form.searchCompany.managerName=e,a.filteredListOfManagers=[]}function C(e){s.getShortCompaniesData(e,function(e){var t=new o.DataObject(e);t.addColourCoding(),a.companyDataList=t.data,l()})}function _(){r.isAnythingSelected(a.selectedCompanies.id,function(e){switch(a.selectedCompanies.id=e,a.emailToCompanies.subject){case"A szerződés lejárt":a.selectedCompanies.type="contractexpired",a.selectedCompanies.subject="A szerződés lejárt";break;case"Utolsó figyelmeztetés":a.selectedCompanies.type="lastwarning",a.selectedCompanies.subject="Utolsó figyelmeztetés"}s.mailToSelectedCompanies(a.selectedCompanies,function(a){r.checkSuccess(a)})})}function M(){p(function(e){a.companyDataEdit=e,a.companyDataEditMaster=angular.copy(a.companyDataEdit),d()})}function D(a){u(a,function(a){s.overWriteCompanyData(a,function(a){r.checkSuccess(a),M()})})}function w(){a.companyDataEdit=angular.copy(a.companyDataEditMaster)}function v(){r.isAnythingSelected(a.selectedCompanies.id,function(e){r.confirmChange(e,function(e){s.changeContractStatus(e,function(e){r.checkSuccess(e),a.form.searchCompany.validContract&&a.form.searchCompany.expiredContract||(a.form.searchCompany.validContract=!a.form.searchCompany.validContract,a.form.searchCompany.expiredContract=!a.form.searchCompany.expiredContract),C(a.form.searchCompany)})})})}function F(){p(function(e){a.companyDataExtend=e,a.companyDataExtendMaster=angular.copy(a.companyDataExtend),m()})}function A(e){u(e,function(e){s.extendContract(e,function(e){r.checkSuccess(e),C(a.form.searchCompany)})})}function S(){a.companyDataExtend=angular.copy(a.companyDataExtendMaster)}function N(a){u(a,function(a){s.addNewCompany(a,function(a){r.checkSuccess(a)})})}function k(a){c.createCover(a,function(){window.location.replace("cover.docx")})}function L(a){c.createContract(a,function(){window.location.replace("contract.docx")})}function b(){0==a.selectedCompanies.allChecked?(angular.forEach(a.companyDataList,function(e){a.selectedCompanies.id.push(e.id)}),a.selectedCompanies.allChecked=!0):(a.selectedCompanies.id=[],a.selectedCompanies.allChecked=!1)}function x(e){n.displayContent(a.display.form,e,function(e){a.display.form=e})}function O(){a.display=angular.copy(a.displayMaster),a.selectedCompanies=angular.copy(a.displayMaster),a.companyDataList=angular.copy(a.companyDataListMaster),a.companyDataEdit=angular.copy(a.companyDataEditMaster),a.companyDataExtend=angular.copy(a.companyDataExtendMaster)}a.display={form:{searchCompany:!1,sendEmail:!1,showDetails:!1,extendContract:!1,addNewCompany:!1},data:{list:!1,edit:!1,extend:!1}},a.form={searchCompany:{companyName:"",managerName:"",validContract:!0,expiredContract:!1,startingDate:null,endingDate:null,lastContractOnly:!0},addNewCompany:{company_name:"",starting_date:new Date,ending_date:new Date,company_phone:"",company_email:"",invoice_number:"",service_provider:"Zeller és Zeller Kft.",transfer_date:new Date,invoice_date:new Date,payment_method:"",account_number:"",price_of_serv_num:0,price_of_serv_let:"",company_address:"",company_register_id:"",company_tax_id:"",postal_number:"",postal_service:"nem",postal_name:"",postal_address:"",manager_name:"",manager_status:"ügyvezető",manager_id:"",manager_mother_name:"",manager_address:"",document_holder:"",document_holder_address:""}},a.filteredListOfCompanies=[],a.filteredListOfManagers=[],a.companyDataList=[],a.sortField="company_name",a.reverseSortField=!1,a.companyDataEdit=[],a.companyDataExtend=[],a.selectedCompanies={id:[],allChecked:!1},a.emailToCompanies={subject:"A szerződés lejárt"},a.displayMaster=angular.copy(a.display),a.selectedCompaniesMaster=angular.copy(a.selectedCompanies),a.companyDataEditMaster=[],a.companyDataExtendMaster=[],a.companyDataListMaster=[],a.menu=x,a.reset=O,a.filterListOfCompanyNames=f,a.filterListOfManagerNames=y,a.insertCompanyNameToInputField=h,a.insertManagerNameToInputField=g,a.formGetCompanyDataList=C,a.formGetCompanyDataEdit=M,a.overwriteCompanyData=D,a.formChangeContractStatus=v,a.formGetCompanyDataExtend=F,a.addExtendedContract=A,a.addNewCompany=N,a.displayCompanyDataList=l,a.resetFormCompanyDataEdit=w,a.resetFormCompanyDataExtend=S,a.docCreateCover=k,a.docCreateContract=L,a.mailToSelectedCompanies=_,a.checkAllCompanies=b}]);var DatabaseFactory=angular.module("DatabaseFactory",[]);DatabaseFactory.factory("Database",["$http",function(a){function e(e,t){a.post("php/companies/form_search_companies.php",e).success(function(a){t(a)})}function t(e,t){a.post("php/companies/form_companies_detailed.php",e).success(function(a){t(a)})}function n(e,t){a.post("php/companies/form_companies_overwrite_company_data.php",e).success(function(a){t(a)})}function i(e,t){a.post("php/companies/form_companies_change_contract_status.php",e).success(function(a){t(a)})}function o(e,t){a.post("php/companies/form_companies_extend_contract.php",e).success(function(a){t(a)})}function r(e,t){a.post("php/companies/form_companies_add_new_company.php",e).success(function(a){t(a)})}function s(e,t){a.post("php/companies/form_companies_mail_to_companies.php",e).success(function(a){t(a)})}function c(e,t){a.post("php/mailing/form_search_mails.php",e).success(function(a){t(a)})}function l(e,t){a.post("php/mailing/form_overwrite_mails.php",e).success(function(a){t(a)})}function d(e,t){a.post("php/mailing/form_delete_mails.php",e).success(function(a){t(a)})}function m(e,t){a.post("php/mailing/form_forward_mails.php",e).success(function(a){t(a)})}function p(e,t){a.post("php/mailing/form_add_new_mails.php",e).success(function(a){t(a)})}return{getShortCompaniesData:e,getDetailedCompaniesData:t,overWriteCompanyData:n,changeContractStatus:i,extendContract:o,addNewCompany:r,mailToSelectedCompanies:s,getMailData:c,overwriteMailData:l,deleteMailData:d,forwardMailData:m,addNewMails:p}}]);var MailingCtrl=angular.module("MailingCtrl",[]);MailingCtrl.controller("MailingCtrl",["$scope","$window","SubMenu","FilteredSearch","Database","FormatData","Alerts","DocMaker",function(a,e,t,n,i,o,r,s){function c(e){n.filterCompanyNames(e,function(e){a.filteredListOfCompanies=e})}function l(e){a.form.searchMail.companyName=e,a.form.addNewMail.companyName=e,a.filteredListOfCompanies=[]}function d(e){i.getMailData(e,function(e){var t=new o.DataObject(e);t.formatDateCorrectlyForMail().addColourCodingToMail(),a.mailDataList=t.data,a.mailDataListMaster=angular.copy(a.mailDataList)})}function m(){r.isAnythingSelected(a.selectedMails.id,function(e){a.form.forwardMail.id=angular.copy(a.selectedMails.id),i.forwardMailData(a.form.forwardMail,function(a){r.checkSuccess(a)})})}function p(){r.isAnythingSelected(a.selectedMails.id,function(e){var t=s.createDataObjectForReceit(e,a.mailDataList);s.createReceit(t,function(a){window.location.replace("receit.docx")})})}function u(){r.isAnythingSelected(a.selectedMails.id,function(e){for(var t=0;t<a.mailDataList.length;t++)a.mailDataList[t].show_input=!1;for(var t=0;t<a.selectedMails.id.length;t++)for(var n=0;n<a.mailDataList.length;n++)a.selectedMails.id[t]==a.mailDataList[n].mail_id&&(a.mailDataList[n].show_input=!0)})}function f(){a.mailDataList=angular.copy(a.mailDataListMaster)}function h(){r.isAnythingSelected(a.selectedMails.id,function(e){i.overwriteMailData(a.mailDataList,function(a){r.checkSuccess(a)})})}function y(){r.isAnythingSelected(a.selectedMails.id,function(a){i.deleteMailData(a,function(a){r.checkSuccess(a)})})}function g(){a.form.addNewMail.mails.push({senderName:"",senderAddress:""})}function C(e){var t=a.form.addNewMail.mails.indexOf(e);-1!=t&&a.form.addNewMail.mails.length>1&&a.form.addNewMail.mails.splice(t,1)}function _(e){n.filterMailingAddresses(e.senderName,e.senderAddress,function(t){a.filteredListOfMailingAddresses=t;for(var n=a.form.addNewMail.mails.indexOf(e),i=0;i<a.form.addNewMail.mails.length;i++)a.form.addNewMail.mails[i].activeField=!1;a.form.addNewMail.mails[n].activeField=!0})}function M(e){for(var t=0;t<a.form.addNewMail.mails.length;t++)1==a.form.addNewMail.mails[t].activeField&&(a.form.addNewMail.mails[t].senderName=e.sender_name,a.form.addNewMail.mails[t].senderAddress=e.sender_address);a.filteredListOfMailingAddresses=[]}function D(){r.fillAddNewMailsForm(a.form.addNewMail.companyName,a.form.addNewMail.receivingDate,a.form.addNewMail.mails,function(){i.addNewMails(a.form.addNewMail,function(a){r.checkSuccess(a)})})}function w(e){t.displayContent(a.display.form,e,function(e){a.display.form=e})}function v(){a.display=angular.copy(A)}function F(){0==a.selectedMails.allChecked?(angular.forEach(a.mailDataList,function(e){a.selectedMails.id.push(e.mail_id)}),a.selectedMails.allChecked=!0):(a.selectedMails.id=[],a.selectedMails.allChecked=!1)}a.display={form:{searchMails:!1,forwardMails:!1,editMails:!1,addNewMails:!1},data:{list:!0}},a.form={searchMail:{companyName:"",startingDate:null,endingDate:null,nonForwarded:!0,forwarded:!1,hasPostalService:!0,doesntHavePoastalService:!0},forwardMail:{forwardingDate:null,forwardingMethod:null,id:null},addNewMail:{companyName:"",receivingDate:null,mails:[{senderName:"",senderAddress:"",activeField:!1}]}},a.mailDataList=[],a.sortField="company_name",a.reverseSortField=!1,a.selectedMails={id:[],allChecked:!1},a.filteredListOfCompanies=[],a.filteredListOfMailingAddresses=[];var A=angular.copy(a.display);a.mailDataListMaster=angular.copy(a.mailDataList),a.menu=w,a.reset=v,a.filterCompanyNames=c,a.insertCompanyNameToInputField=l,a.formGetMailDataList=d,a.checkAll=F,a.checkAllMails=F,a.editMails=u,a.resetMails=f,a.overwriteMails=h,a.deleteMails=y,a.forwardMails=m,a.printReceit=p,a.filterListOfMailingAddresses=_,a.insertMailingAddressToAddNewMailField=M,a.addNewRowToAddMailForm=g,a.removeRowFromAddMailForm=C,a.addNewMails=D}]);var MailingFactory=angular.module("MailingFactory",[]);MailingFactory.factory("MailingFactory",["$http",function(a){}]);var SubMenuFactory=angular.module("SubMenuFactory",[]);SubMenuFactory.factory("SubMenu",[function(){function a(a,e,t){for(var n in a)n==e?a[n]=!0:a[n]=!1;t(a)}return{displayContent:a}}]);var FilteredSearchFactory=angular.module("FilteredSearchFactory",[]);FilteredSearchFactory.factory("FilteredSearch",["$http",function(a){function e(e){c?e(c):a.get("php/companies/fetch_company_names.php").success(function(a){c=a,e(a)})}function t(e){l?e(l):a.get("php/companies/fetch_manager_names.php").success(function(a){l=a,e(a)})}function n(e){d?e(d):a.get("php/mailing/fetch_mailing_addresses.php").success(function(a){d=a,e(a)})}function i(a,e){var t=e,n=[];if(0!==a.length)for(var i=0;i<t.length;i++)t[i].substring(0,a.length).toLowerCase()===a.toLowerCase()&&n.push(t[i]);return n}function o(a,t){e(function(e){t(i(a,e))})}function r(a,e){t(function(t){e(i(a,t))})}function s(a,e,t){var i=[],o=[];n(function(n){if(i=n,0!==a.length||0!==e.length)for(var r=0;r<i.length;r++)i[r].sender_name.substring(0,a.length).toLowerCase()===a.toLowerCase()&&i[r].sender_address.substring(0,e.length).toLowerCase()===e.toLowerCase()&&o.push(i[r]);t(o)})}var c,l,d;return{filterCompanyNames:o,filterManagerNames:r,filterMailingAddresses:s}}]);var FormatDataFactory=angular.module("FormatDataFactory",[]);FormatDataFactory.factory("FormatData",[function(){function a(a){var e=new Date(a);return e}function e(a){this.data=a}return e.prototype.addColourCoding=function(){return this.data.map(function(a){1!=a.contract_status||""!=a.postal_number&&null!=a.postal_number?1==a.contract_status?a.css_color="green":a.css_color="red":a.css_color="yellow"}),this},e.prototype.formatDateCorrectly=function(){return this.data.map(function(e){"1970-01-01"==e.starting_date||"0000-00-00"==e.starting_date||null==e.starting_date?e.starting_date=null:e.starting_date=a(e.starting_date),"1970-01-01"==e.ending_date||"0000-00-00"==e.ending_date||null==e.ending_date?e.ending_date=null:e.ending_date=a(e.ending_date),"1970-01-01"==e.transfer_date||"0000-00-00"==e.transfer_date||null==e.transfer_date?e.transfer_date=null:e.transfer_date=a(e.transfer_date),"1970-01-01"==e.invoice_date||"0000-00-00"==e.invoice_date||null==e.invoice_date?e.invoice_date=null:e.invoice_date=a(e.invoice_date)}),this},e.prototype.formatPostalServiceToString=function(){return this.data.map(function(a){1==a.postal_service?a.postal_service="igen":a.postal_service="nem"}),this},e.prototype.formatPostalServiceToBoolean=function(){return this.data.map(function(a){"igen"==a.postal_service?a.postal_service=1:a.postal_service=0}),this},e.prototype.addColourCodingToMail=function(){return this.data.map(function(a){a.show_input=!1,null==a.forwarding_date?a.css_color="yellow":a.css_color="green"}),this},e.prototype.formatDateCorrectlyForMail=function(){return this.data.map(function(e){e.receiving_date=a(e.receiving_date),"1970-01-01"==e.forwarding_date||"0000-00-00"==e.forwarding_date||null==e.forwarding_date?e.forwarding_date=null:e.forwarding_date=a(e.forwarding_date)}),this},{DataObject:e}}]);var AlertsFactory=angular.module("AlertsFactory",[]);AlertsFactory.factory("Alerts",[function(){function a(a,e){0==a.length?alert("Nem választottál ki semmit!"):e(a)}function e(a){1==a?alert("A feladat sikeresen végrehajtva!"):alert("Nem sikerült a kért műveletet elvégezni!")}function t(a,e){var t=confirm("Végre akarod hajtani a kívánt változtatásokat?");t&&e(a)}function n(a,e,t,n){var i=!1;(null==a||""==a)&&(i=!0),null==e&&(i=!0);for(var o=0;o<t.length;o++)(0==t[o].senderName.length||0==t[o].senderAddress.length)&&(i=!0);1==i?alert("Minden mezőt kötelező kitölteni!"):n()}return{isAnythingSelected:a,checkSuccess:e,confirmChange:t,fillAddNewMailsForm:n}}]);var DocMakerFactory=angular.module("DocMakerFactory",[]);DocMakerFactory.factory("DocMaker",["$http",function(a){function e(e,t){a({method:"POST",url:"php/companies/document_create_cover.php",data:e}).success(function(){t()})}function t(e,t){a({method:"POST",url:"php/companies/document_create_contract.php",data:e}).success(function(){t()})}function n(a,e){for(var t=[],n=0;n<a.length;n++)for(var i=0;i<e.length;i++)a[n]==e[i].mail_id&&t.push(e[i]);return t}function i(e,t){a({method:"POST",url:"php/mailing/document_create_receit.php",data:e}).success(function(){t()})}return{createContract:t,createCover:e,createReceit:i,createDataObjectForReceit:n}}]);